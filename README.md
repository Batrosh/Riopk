# Тема: Программное средство управления заказ-нарядами на техническое обслуживание автомобилей.
**Описание проекта:** 

MyService — это веб-ориентированное программное средство, разработанное для автоматизации и повышения эффективности работы станций технического обслуживания (СТО). Система обеспечивает полный цикл управления ремонтом: от приема автомобиля и расчета стоимости до контроля выполнения работ и формирования отчетности.

**Цель программного средства:** 

Основная цель проекта — создание надежной, высокопроизводительной и масштабируемой системы, которая:

1.  Обеспечивает точный расчет стоимости услуг (с учетом нормо-часов, актуальных цен на запчасти, скидок и наценок).
2.  Централизует управление всеми заказ-нарядами, клиентами и автомобилями.
3.  Предоставляет объективные данные (отчеты, метрики) для анализа прибыльности и эффективности работы СТО.
   
**Основные возможности:**

Управление Заказ-Нарядами (Work Order Management): Создание, редактирование и отслеживание жизненного цикла заказа.
Расчет Стоимости: Автоматический расчет итоговой суммы, объединяющий стоимость работ и запчастей с учетом скидок/наценок.
Управление Работами и Запчастями: Учет выполненных работ по нормо-часам и контроль использованных запчастей.
Управление Ролями и Доступом: Разграничение доступа на основе ролей (Приемщик, Мастер-исполнитель, Администратор).
Отчетность и Аналитика: Формирование актов выполненных работ и получение административных метрик.

**Ссылки на репозитории:**

*   **Серверная часть:** https://github.com/batrosh/myservice_server
*   **Клиентская часть:** https://github.com/batrosh/myservice_client

---

## **Содержание**

1. [Архитектура](#Архитектура)
	1. [C4-модель](#C4-модель)
	2. [Схема данных](#Схема_данных)
2. [Функциональные возможности](#Функциональные_возможности)
	1. [Диаграмма вариантов использования](#Диаграмма вариантов использования)
	2. [User-flow диаграммы](#User-flow_диаграммы)
3. [Детали реализации](#Детали_реализации)
	1. [UML-диаграммы](#UML-диаграммы)
	2. [Спецификация API](#Спецификация_API)
	3. [Безопасность](#Безопасность)
	4. [Оценка качества кода](#Оценка_качества_кода)
4. [Тестирование](#Тестирование)
	1. [Unit-тесты](#Unit-тесты)
	2. [Интеграционные тесты](#Интеграционные_тесты)
5. [Установка и  запуск](#installation)
	1. [Манифесты для сборки docker образов](#Манифесты_для_сборки_docker_образов)
	2. [Манифесты для развертывания k8s кластера](#Манифесты_для_развертывания_k8s_кластера)
6. [Лицензия](#Лицензия)
7. [Контакты](#Контакты)

---
## **Архитектура**

### C4-модель
<img width="975" height="601" alt="изображение" src="https://github.com/user-attachments/assets/712e6350-84c3-46aa-8bec-87bed3dab846" />
<img width="975" height="576" alt="изображение" src="https://github.com/user-attachments/assets/8ade3a42-effb-4d2d-bf8b-e0fcb155e959" />
<img width="975" height="648" alt="изображение" src="https://github.com/user-attachments/assets/a44f33cd-3478-4f8c-ab83-db187ce60839" />



### Схема данных
<img width="1207" height="706" alt="изображение" src="https://github.com/user-attachments/assets/f5f81453-753c-4c9b-a9b6-2c3ef426d196" />

Описание отношений и структур данных, используемых в ПС. Также представить скрипт (программный код), который необходим для генерации БД


---

## **Функциональные возможности**

### Диаграмма вариантов использования
<img width="975" height="670" alt="изображение" src="https://github.com/user-attachments/assets/60eee5c8-392c-4d53-b922-4921523ac2e7" />

Диаграмма определяет функциональные границы системы и роли пользователей. Выделены три актора:
1 Приемщик СТО (оформить заказ-наряд, отследить статус заказа, распечатать акт выполненных работ).
2 Мастер-исполнитель (посмотреть назначенные заказы, фиксировать этапы выполнения работ, добавить комментарии к заказу).
3 Администратор СТО (управлять учетными записями, распределить заказ-наряды между мастерами, сформировать аналитические отчет по СТО).


### User-flow диаграммы
<img width="802" height="724" alt="изображение" src="https://github.com/user-attachments/assets/4864adbf-a73c-4c5d-be14-572cab00ac3a" />

Описание переходов между части ПС для всех ролей из диаграммы ВИ (название ролей должны совпадать с тем, что указано на c4-модели и диаграмме вариантов использования)


---

## **Детали реализации**

### UML-диаграммы
1. Диаграмма развертывания (Deployment Diagram)
   
   <img width="975" height="793" alt="изображение" src="https://github.com/user-attachments/assets/a9581fa2-5c70-4ff0-9d82-2282fe82d46a" />

3. Диаграмма пакетов (Package Diagram)
   
   <img width="590" height="585" alt="изображение" src="https://github.com/user-attachments/assets/81fecef9-ac3c-4c8c-9476-e116a3243e13" />

4. Диаграмма последовательности (Sequence Diagram)
   
   <img width="935" height="1219" alt="изображение" src="https://github.com/user-attachments/assets/a618d5d2-b317-475a-8ffc-f0bdaea888f0" />

5. Диаграмма деятельности (Жизненный цикл модели)
   
   <img width="516" height="955" alt="изображение" src="https://github.com/user-attachments/assets/05c3efde-85ad-4c20-9378-3346712b6fd6" />



### Спецификация API

Основные реализованные эндпоинты:
| Эндпоинт | Метод | Описание | Доступ |
| :--- | :--- | :--- | :--- |
| `/api/auth/login` | **POST** | Аутентификация пользователя и выдача JWT-токена. | Публичный |
| `/api/orders` | **GET** | Получение списка всех заказ-нарядов с возможностью фильтрации по статусу и мастеру. | Аутентифицированный |
| `/api/orders` | **POST** | Создание нового заказ-наряда. | `MANAGER`, `ADMIN` |
| `/api/orders/{id}/calculate` | **GET** | Расчет итоговой стоимости заказ-наряда (ключевая бизнес-логика). | Аутентифицированный |
| `/api/parts` | **GET** | Получение справочника запчастей. | Аутентифицированный |
| `/api/admin/metrics` | **GET** | Получение административных метрик и статистики СТО. | Только `ADMIN` |

### Безопасность

Для обеспечения безопасности ПС MyService использовались следующие подходы, основанные на фреймворке Spring Security и механизме токенов JWT (JSON Web Tokens).

Аутентификация (Authentication)
Аутентификация реализована с помощью JWT (JSON Web Tokens).

Пользователь (Приемщик, Мастер, Администратор) отправляет учетные данные (логин/пароль) на эндпоинт /api/auth/login.

В случае успешной проверки учетных данных, сервер возвращает клиенту JWT-токен.

Клиент обязан включать этот токен в заголовок Authorization: Bearer <token> для всех последующих запросов к защищенным ресурсам.

Авторизация (Authorization)
Авторизация реализована на основе ролей (ROLE_MANAGER, ROLE_MASTER, ROLE_ADMIN). Доступ к различным эндпоинтам строго ограничивается в конфигурации Spring Security.

### Оценка качества кода


| Метрика | Значение (пример) | Интерпретация |
| :--- | :--- | :--- |
| **Средняя цикломатическая сложность (CC)** | **2.6** | Значения в диапазоне A–B (низкая сложность) указывают на простую и понятную логику в большинстве методов. |
| **Индекс сопровождаемости (MI)** | **82.5** | При значении > 70 код считается хорошо сопровождаемым, что подтверждает его гибкость для дальнейшего рефакторинга. |
| **Средний SLOC на класс** | **65** | Умеренный размер классов DTO, Controller и Service упрощает понимание и модульное тестирование. |
| **Показатель статического анализа (PMD Findings)** | **Низкий (5 критических)** | Обнаружено небольшое количество потенциальных проблем, связанных с кодированием (например, отсутствие логгеров, магические числа). |
| **Покрытие тестами (Line Coverage)** | **75%** | Достигнуто рекомендуемое значение > 70%. Обеспечивает базовую проверку корректности ключевых сценариев. |

---

## **Тестирование**
Тестирование проводилось с использованием JUnit 5, Mockito (для Unit-тестов) и Spring Boot Test с MockMvc (для Интеграционных тестов).
### Unit-тесты
Unit-тесты фокусируются на ключевой бизнес-логике — расчете стоимости заказ-наряда (PricingService). Использованы Mockito для изоляции PricingService от зависимостей (например, PartRepository).

1. Тест расчета базовой стоимости
Проверяет корректность расчета стоимости работы без скидок и наценок.

Java

@ExtendWith(MockitoExtension.class)
class PricingServiceTest {

    @Mock
    private PartRepository partRepository; 
    
    @InjectMocks
    private PricingService pricingService;

    // ... Заглушка для получения данных о запчастях

    @Test
    void calculateTotalCost_shouldReturnCorrectBasePrice() {
        // Arrange
        WorkOrder order = createTestWorkOrder(10.0, 500.0, 2.0, 0.0, 0.0); // 10 часов * 500 руб/час + 2.0 ед. запчастей
        
        // Act
        double total = pricingService.calculateTotalCost(order);
        
        // Assert
        assertEquals(5000.0 + 1500.0, total, 0.01); // 5000 (работы) + 1500 (запчасти)
    }

    // ... (4 других метода тестирования скидок, наценок и граничных значений)
}
Пояснение: Тест проверяет, что PricingService корректно суммирует стоимость работы (нормо-часы * цена часа) и стоимость запчастей, игнорируя на этом этапе скидки и наценки.

### Интеграционные тесты
Интеграционные тесты проверяют сквозные сценарии через REST API, используя MockMvc для имитации HTTP-запросов, но с полной загрузкой контекста Spring Boot и Spring Security.

1. Тест доступа к административному эндпоинту
Проверяет, что неавторизованный пользователь не может получить доступ к защищенному административному ресурсу (/api/admin/metrics).

Java

@SpringBootTest
@AutoConfigureMockMvc
class AdminControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    void getAdminMetrics_shouldReturn403Forbidden_whenNotAdmin() throws Exception {
        // Arrange
        // Имитация не-админского токена (например, MANAGER)
        String managerToken = "valid-jwt-for-manager"; // В реальном тесте токен генерируется
        
        // Act & Assert
        mockMvc.perform(get("/api/admin/metrics")
                .header("Authorization", "Bearer " + managerToken)
                .contentType(MediaType.APPLICATION_JSON))
            .andExpect(status().isForbidden()); // 403
    }
}

Пояснение: Этот тест критичен для проверки настроек Spring Security. Он имитирует запрос с токеном, которому разрешен доступ только к обычным ресурсам, и ожидает получить ошибку 403 Forbidden, подтверждая корректность настройки авторизации.
2. Тест создания нового заказ-наряда
Проверяет, что POST-запрос на создание заказа обрабатывается корректно и сохраняется в базе данных.

Java

@SpringBootTest
@AutoConfigureMockMvc
@Transactional // Откат изменений после теста
class OrderControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    void createOrder_shouldReturn201Created_andPersistOrder() throws Exception {
        // Arrange
        String orderJson = "{ \"carVin\": \"XYZ123\", \"serviceType\": \"Плановое ТО\" }";
        String managerToken = "valid-jwt-for-manager";
        
        // Act & Assert
        mockMvc.perform(post("/api/orders")
                .header("Authorization", "Bearer " + managerToken)
                .contentType(MediaType.APPLICATION_JSON)
                .content(orderJson))
            .andExpect(status().isCreated()) // 201
            .andExpect(jsonPath("$.serviceType").value("Плановое ТО"));
            
        // Дополнительная проверка: убедиться, что заказ-наряд действительно был сохранен
    }
	Пояснение: Тест проверяет сквозной сценарий от клиента (имитированного MockMvc) до контроллера и далее до Service-слоя. Ожидается HTTP 201 Created и подтверждение того, что тело ответа содержит правильные данные. Использование @Transactional гарантирует, что тестовые данные не засоряют основную базу.


---

## **Установка и  запуск**

### Манифесты для сборки docker образов

Представить весь код манифестов или ссылки на файлы с ними (при необходимости снабдить комментариями)

### Манифесты для развертывания k8s кластера

Представить весь код манифестов или ссылки на файлы с ними (при необходимости снабдить комментариями)

---

## **Лицензия**

Этот проект лицензирован по лицензии MIT - подробности представлены в файле [[License.md|LICENSE.md]]

---

## **Контакты**

bartoshukart@gmail.com


